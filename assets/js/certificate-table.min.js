!function(c){var d=SST_Certificate_Table_Data,a=wp.template("sst-certificate-row"),n=wp.template("sst-certificate-row-blank"),e=Backbone.Model.extend({certificates:{},selected:""}),t=Backbone.View.extend({userId:0,addressFields:{},initialize:function(e){this.userId=e.user_id?+e.user_id:0,this.addressFields=e.address_fields||{},this.listenTo(this.model,"change:certificates",this.render),this.listenTo(this.model,"change:selected",this.fireChangeHook),c(document.body).on("click",".sst-certificate-add",{view:this},this.onAddCertificate)},render:function(){var e=_.indexBy(this.model.get("certificates"),"CertificateID"),t=this.model.get("selected"),i=this,s=1;this.$el.empty(),_.size(e)?(c.each(e,function(e,t){t.Index=s++,i.$el.append(a(t))}),i.$el.find(".sst-certificate-delete").on("click",{view:this},this.onDeleteRow),i.$el.find(".sst-certificate-view").on("click",{view:this},this.onViewCertificate),i.$el.find('input[name="certificate_id"]').on("change",this.updateSelected.bind(this)),t?c('input[name="certificate_id"][value="'+t+'"]').prop("checked",!0):(e=c('input[name="certificate_id"]').first())&&(e.prop("checked",!0),this.model.set("selected",e.val()))):i.$el.append(n)},fireChangeHook:function(){var e=this.model.get("selected");wp.hooks.doAction("sst_certificate_changed",e)},block:function(){c(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){c(this.el).unblock()},updateSelected:function(e){this.model.set("selected",c(e.target).val())},onDeleteRow:function(e){var t=e.data.view,i=t.model,s=(_.indexBy(i.get("certificates"),"CertificateID"),t.model.get("selected")),a=c(this).closest("tr").data("id");e.preventDefault(),confirm(d.strings.delete_certificate)&&(t.block(),i={nonce:d.delete_certificate_nonce,certificate_id:a},t.userId&&(i.user_id=t.userId),c.post(d.ajaxurl+"?action=sst_delete_certificate",i).then(function(e){if(!e.success)throw new Error(e.data);s==a&&t.model.set("selected",""),t.model.set("certificates",e.data.certificates),t.model.trigger("change:certificates")}).fail(function(){alert(d.strings.delete_failed)}).always(function(){t.unblock()}))},onViewCertificate:function(e){var t=e.data.view.model,t=_.indexBy(t.get("certificates"),"CertificateID")[c(this).closest("tr").data("id")];e.preventDefault(),t&&c(this).SSTBackboneModal({template:"sst-modal-view-certificate",variable:t})},onAddCertificate:function(e){e.preventDefault();e=e.data.view;SST_Add_Certificate_Modal.open({address:e.getBillingAddress(),onAddCertificate:e.addCertificateHandler.bind(e)})},getBillingAddress:function(){var e,t,i=d.billing_address,s=this.addressFields;for(e in i)i.hasOwnProperty(e)&&e in s&&(t=s[e],(t=c('[name="'+t+'"]')).length&&(i[e]=t.val()));return i},addCertificateHandler:function(e){var t=this,e=(t.block(),{nonce:SST_Add_Certificate_Data.nonce,address:t.getBillingAddress(),...e});t.userId&&(e.user_id=t.userId),c.post(d.ajaxurl+"?action=sst_add_certificate",e).then(function(e){if(!e.success)throw new Error(e.data);t.model.set("selected",e.data.certificate_id),t.model.set("certificates",e.data.certificates),t.model.trigger("change:certificates")}).fail(function(){alert(d.strings.add_failed)}).always(function(){t.unblock()})}});var i={user_id:d.user_id,certificates:d.certificates};i=i||{};var s,r={selector:"#sst-certificates",address_fields:{first_name:"billing_first_name",last_name:"billing_last_name",address_1:"billing_address_1",address_2:"billing_address_2",country:"billing_country",city:"billing_city",state:"billing_state",postcode:"billing_postcode"},certificates:{},selected:"",user_id:0};for(s in r)r.hasOwnProperty(s)&&!i.hasOwnProperty(s)&&(i[s]=r[s]);i.model=new e({certificates:i.certificates,selected:i.selected}),i.el=c(i.selector).find("tbody"),new t(i).render()}(jQuery);